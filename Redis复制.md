## Redis复制

Redis支持简单易用的主从复制功能，该功能可以让从服务器成为主服务器的精确复制品。

以下是关于Redis复制功能的几个重要方面：

	* Redis使用异步复制。从Redis2.8开始，从服务器会以每秒一次的频率向主服务器报告复制流的处理进度

	* 一个主服务器可以有多个从服务器
	* 不仅主服务器可以有从服务器，从服务器也可以有自己的从服务器，多个从服务器之间可以构成一个图状结构

	* 复制功能不会阻塞主服务器：即使有一个或多个从服务器正则进行初步同步，主服务器也可以继续处理命令请求。

	* 复制功能也不会阻塞从服务器：只要在redis.conf文件中进行了相应的设置，即使从服务器正在进行初步同步，服务器也可以使用旧版本的数据集来处理命令查询。

不过，在从服务器删除旧版本数据集并载入新版本数据的那段时间内，连接请求会被阻塞。

还可以配置从服务器，让它在与主服务器之间的连接断开时，向客户端发送一个错误。

	* 复制功能可以单纯地用于数据冗余，也可以通过多个从服务器处理只读命令请求来提升扩展性。比如：sort命令可以交给从服务器去运行。

	* 可以通过复制功能来让主服务器免于执行持久化操作：只要关闭主服务器的持久化功能，然后由从服务器去执行持久化操作即可。


## 关闭主服务器持久化时，复制功能的数据安全

当配置Redis复制功能时，强烈建议打开主服务器的持久化功能。否则，由于延迟等问题，部署的服务器应该要避免自动拉起。

为了帮助理解主服务器关闭持久化时自动拉起的危险性，参考一下以下会导致主从服务器数据全部丢失的例子：


1. 假设节点A为主服务器，并且关闭了持久化。并且节点B和节点C从节点A复制数据

2. 节点A崩溃，然后由自动拉起服务重启了节点A,由于节点A的持久化被关闭了，所以重启之后没有任何数据

3. 节点B和节点B将从节点A复制数据，但是A的数据是空的，于是就把自身保存的数据副本删除。


无论何时，数据安全都是极其重要的，所以应该禁止主服务器关闭持久化的同时自动拉起。

## 复制功能的运作原理

无论是初次连接还是重新连接，当建立一个从服务器时，从服务器都将向主服务器发送一个sync命令。

接到sync命令的主服务器将开始执行bgsave,并在保存操作执行期间，将所有新执行的写入命令都保存到一个缓冲区里面。

当bgsave执行完毕后，主服务器将执行保存操作所得到的.rdb文件发送给从服务器，从服务器接收这个.rdb文件，并将文件中的数据载入到内存中。

之后主服务器会以redis命令协议的格式，将写命令缓冲区中积累的所有内容都发送给从服务器。

## 部分重同步

从Redis2.8开始，在网络连接短暂性失效之后，主从服务器可以尝试继续执行原有的复制进程，而不一定要执行完整重同步操作。

这个特性需要主服务器为被发送的复制流创建一个内存缓冲区，并且主服务器和所有从服务器之间都记录一个复制偏移量和一个主服务器ID,当出现网络连接断开时，从服务器会重新连接，并且向主服务器请求继续执行原来的复制进程：

	* 如果从服务器记录的主服务器ID和当前要连接的主服务器的ID想听，并且从服务器记录的偏移量所指定的数据依然保存在主服务器的复制流缓冲区里面，那么主服务器会向从服务器发送断线时缺失的那部分数据，然后复制功能可以继续执行。
	* 否则的话，从服务器就要执行完整重同步操作。


## 配置

配置一个从服务器非常简单，只要在配置文件中增加以下的这一行就可以了：

		slaveof 192.168.1.1 6379

另外一种方法是调用slaveof命令，输入主服务器的iP和端口，然后同步就会开始：

	redis> slaveof 192.168.1.1 6379



## 只读从服务器

从redis2.6开始，从服务器支持只读模式，并且该模式为从服务器的默认模式。

只读模式由redis.conf文件中的slave-read-only选项控制，也可以通过config set 命令来开启或关闭这个模式。

只读从服务器会拒绝任何写命令，所以不会出现因为操作失误而将数据不小心写入到了从服务器的情况。


即使从服务器是只读的，DEBUG和CONFIG等管理式命令是可以使用的，所以我们还是不应该将服务器暴露给互联网或者任何不可信网络。不过，使用redis.conf中的命令改名选项，我们可以通过禁止执行某些命令来提升只读从服务器的安全性。

### 从服务器相关配置

如果主服务器通过requirepass选项设置了密码，那么为了让从服务器的同步操作可以顺利进行，我们也必须为从服务器进行相应的身份验证设置。

对于一个正在运行的服务器，可以使用服务器端输入下面命令：

	redis>  config set masterauth <password>


要永久地设置这个密码，那么可以将它加入到配置文件中：

	masterauth <password>


### 主服务器只在有至少N个从服务器的情况下，才执行写操作

从Redis2.8开始，为了保证数据的安全性，可以通过设置，让主服务器只在只有至少N个当前已连接从服务器的情况下，才执行写命令。

不过，因为redis使用异步复制，所以主服务器发送的写数据并不一定会被从服务器接收到，因此，数据丢失的可能性还是存在的。

以下是这个特性的运作原理：

	* 从服务器以每秒一次的频率ping主服务器一次，并报告复制流的处理情况
	* 主服务器会记录各个从服务器最后一次向它发送ping的时间
	* 用户可以通过配置，指定网络延迟的最大值min-slaves-max-lag,以及执行写操作所需的至少从服务器数量min-slaves-to-write

